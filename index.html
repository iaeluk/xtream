<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineStream XC - Diagnostic Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background-color: #050505; color: #e5e5e5; font-family: 'Segoe UI', sans-serif; }
        .glass-panel { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: rgba(0, 0, 0, 0.5); border: 1px solid #333; color: white; transition: all 0.3s; }
        .input-field:focus { border-color: #e50914; outline: none; background: rgba(0, 0, 0, 0.8); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <script type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Play, Tv, Film, LogOut, Loader2, AlertTriangle, ShieldAlert, Zap, Settings, ExternalLink, Globe, Smartphone, RefreshCw } from 'lucide-react';

        // --- LISTA ESTENDIDA DE GATEWAYS ---
        const GATEWAYS = [
            { id: 'corsproxy', url: 'https://corsproxy.io/?' },
            { id: 'allorigins', url: 'https://api.allorigins.win/raw?url=' },
            { id: 'codetabs', url: 'https://api.codetabs.com/v1/proxy?quest=' },
            { id: 'thingproxy', url: 'https://thingproxy.freeboard.io/fetch/' }
        ];

        const DEFAULT_CREDENTIALS = {
            host: "http://sempretv.sbs",
            username: "",
            password: ""
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState("");
            const [error, setError] = useState(null);
            
            // Estados de Dados
            const [vod, setVod] = useState([]);
            const [live, setLive] = useState([]);
            const [activeTab, setActiveTab] = useState('home');
            
            // Modo Manual/Falha
            const [manualMode, setManualMode] = useState(false);
            const [customProxy, setCustomProxy] = useState("");

            useEffect(() => {
                const saved = localStorage.getItem('xc_user_v11');
                if (saved) setUser(JSON.parse(saved));
            }, []);

            // --- MOTOR DE DIAGNÓSTICO E CONEXÃO ---
            const connect = async (host, username, password, forceProxy = null) => {
                setLoading(true);
                setError(null);
                setManualMode(false);
                
                const baseUrl = host.endsWith('/') ? host.slice(0, -1) : host;
                const apiQuery = `/player_api.php?username=${username}&password=${password}`;
                const targetUrl = baseUrl + apiQuery;

                let successGateway = null;
                let authData = null;

                // Se o usuário definiu um proxy manual, usa só ele
                const proxiesToTry = forceProxy ? [{ id: 'manual', url: forceProxy }] : GATEWAYS;

                for (const gw of proxiesToTry) {
                    setStatus(`Testando rota: ${gw.id}...`);
                    try {
                        const res = await fetch(gw.url + encodeURIComponent(targetUrl));
                        if (!res.ok) throw new Error("HTTP " + res.status);
                        
                        const json = await res.json();
                        if (json.user_info) {
                            successGateway = gw.url;
                            authData = json;
                            break; 
                        }
                    } catch (e) {
                        console.warn(`Falha em ${gw.id}`, e);
                    }
                }

                if (successGateway && authData) {
                    if (authData.user_info.auth === 0) {
                        setError("Conexão feita, mas login inválido (Auth=0). Verifique usuário/senha.");
                        setLoading(false);
                        return;
                    }

                    setStatus("Conectado! Baixando catálogo...");
                    const userData = { host: baseUrl, username, password, authData, gateway: successGateway };
                    setUser(userData);
                    localStorage.setItem('xc_user_v11', JSON.stringify(userData));
                    
                    // Tenta baixar canais e filmes
                    try {
                         const pFetch = (act) => fetch(successGateway + encodeURIComponent(baseUrl + "/player_api.php?username=" + username + "&password=" + password + "&action=" + act)).then(r => r.json());
                         const [l, v] = await Promise.all([ pFetch('get_live_streams'), pFetch('get_vod_streams') ]);
                         setLive(l || []);
                         setVod(v || []);
                    } catch (err) {
                        // Se falhar o download das listas mas o login funcionou
                        setError("Login OK, mas falha ao baixar lista grande via Proxy (Timeout).");
                        setManualMode(true); // Ativa modo de links diretos
                    }
                } else {
                    setError("Bloqueio Total: Nenhum proxy público conseguiu acessar seu servidor.");
                    setManualMode(true); // Oferece soluções manuais
                }
                setLoading(false);
            };

            const logout = () => {
                setUser(null);
                setVod([]);
                setLive([]);
                localStorage.removeItem('xc_user_v11');
                setManualMode(false);
            };

            // --- GERAÇÃO DE LINK DIRETO (SEM JSON) ---
            const openDirect = (type, id, ext) => {
                // Abre direto no player nativo do Android usando Intent
                const streamUrl = `${user.host}/${type}/${user.username}/${user.password}/${id}.${ext}`;
                const intent = `intent:${streamUrl}#Intent;type=video/*;scheme=http;package=org.videolan.vlc;end`;
                
                // Fallback: Tenta abrir o link direto se intent falhar
                const fallback = () => window.location.href = streamUrl;
                
                try { window.location.href = intent; } catch(e) { fallback(); }
            };

            // --- RENDERIZADORES ---

            const LoginScreen = () => {
                const [h, sH] = useState(DEFAULT_CREDENTIALS.host);
                const [u, sU] = useState(DEFAULT_CREDENTIALS.username);
                const [p, sP] = useState(DEFAULT_CREDENTIALS.password);
                const [cp, sCp] = useState("");

                return React.createElement('div', { className: "min-h-screen flex items-center justify-center p-4 bg-[url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08737b/US-en-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg')] bg-cover" },
                    React.createElement('div', { className: "glass-panel p-8 rounded-xl max-w-md w-full shadow-2xl" },
                        React.createElement('h1', { className: "text-red-600 text-4xl font-black mb-6 text-center" }, "XC", React.createElement('span', { className: "text-white" }, "DIAGNOSTIC")),
                        
                        error && React.createElement('div', { className: "bg-red-900/50 border-l-4 border-red-500 p-4 mb-4" },
                            React.createElement('div', { className: "flex items-center gap-2 font-bold text-red-200" }, React.createElement(AlertTriangle, { size: 18 }), "Falha de Conexão"),
                            React.createElement('p', { className: "text-xs text-red-100 mt-1" }, error)
                        ),

                        loading && React.createElement('div', { className: "bg-blue-900/30 p-3 mb-4 rounded text-blue-200 text-xs font-mono flex items-center gap-2" },
                            React.createElement(Loader2, { className: "animate-spin", size: 14 }), status
                        ),

                        React.createElement('form', { onSubmit: (e) => { e.preventDefault(); connect(h, u, p, cp); }, className: "flex flex-col gap-3" },
                            React.createElement('input', { className: "input-field p-3 rounded", placeholder: "URL (http://...)", value: h, onChange: e => sH(e.target.value) }),
                            React.createElement('input', { className: "input-field p-3 rounded", placeholder: "Usuário", value: u, onChange: e => sU(e.target.value) }),
                            React.createElement('input', { className: "input-field p-3 rounded", type: "password", placeholder: "Senha", value: p, onChange: e => sP(e.target.value) }),
                            
                            // Opção de Proxy Manual
                            React.createElement('div', { className: "mt-2 pt-2 border-t border-gray-700" },
                                React.createElement('p', { className: "text-[10px] text-gray-400 mb-1" }, "Opcional: Proxy Personalizado (Se o automático falhar)"),
                                React.createElement('input', { className: "input-field p-2 rounded w-full text-xs font-mono text-green-400", placeholder: "https://meu-worker.workers.dev?url=", value: cp, onChange: e => sCp(e.target.value) })
                            ),

                            React.createElement('button', { disabled: loading, className: "bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded mt-2 flex justify-center items-center gap-2" }, 
                                loading ? "Diagnosticando..." : "Conectar"
                            )
                        ),

                        // Painel de Soluções Manuais (Só aparece se houver erro)
                        manualMode && React.createElement('div', { className: "mt-6 bg-gray-900/80 p-4 rounded border border-gray-700" },
                            React.createElement('h3', { className: "font-bold text-sm text-yellow-500 mb-2 flex items-center gap-2" }, React.createElement(Zap, {size:14}), "Soluções Alternativas"),
                            React.createElement('ul', { className: "text-xs space-y-2 text-gray-300" },
                                React.createElement('li', null, "1. ", React.createElement('strong', null, "Navegador Kiwi:"), " Instale o 'Kiwi Browser' no Android."),
                                React.createElement('li', null, "2. ", React.createElement('strong', null, "Extensão:"), " Instale a extensão 'Allow CORS' no Kiwi."),
                                React.createElement('li', null, "3. ", React.createElement('strong', null, "Gerador:"), " Se nada funcionar, use este site apenas para gerar links para o VLC.")
                            )
                        )
                    )
                );
            };

            const Dashboard = () => {
                // Se estamos logados mas sem lista (bloqueio parcial), mostramos o modo gerador
                const isPartial = user && (vod.length === 0 && live.length === 0);

                return React.createElement('div', { className: "bg-[#050505] min-h-screen pb-20" },
                    // Navbar
                    React.createElement('div', { className: "fixed top-0 w-full z-50 bg-black/90 px-4 py-3 flex justify-between items-center border-b border-gray-800" },
                        React.createElement('h1', { className: "text-red-600 font-black text-xl" }, "CINESTREAM"),
                        React.createElement('button', { onClick: logout, className: "text-gray-400" }, React.createElement(LogOut, { size: 20 }))
                    ),

                    // Conteúdo
                    React.createElement('div', { className: "pt-20 px-4" },
                        isPartial ? React.createElement('div', { className: "text-center mt-10" },
                            React.createElement(ShieldAlert, { className: "mx-auto text-yellow-500 mb-4", size: 48 }),
                            React.createElement('h2', { className: "text-xl font-bold mb-2" }, "Modo de Acesso Direto"),
                            React.createElement('p', { className: "text-sm text-gray-400 mb-6" }, "A lista é muito grande ou o proxy foi bloqueado. Mas suas credenciais estão corretas."),
                            React.createElement('div', { className: "bg-gray-900 p-4 rounded text-left max-w-sm mx-auto border border-gray-800" },
                                React.createElement('p', { className: "text-xs font-bold text-gray-500 uppercase mb-2" }, "Teste de Canais (ID Manual)"),
                                React.createElement('div', { className: "flex gap-2" },
                                    React.createElement('button', { onClick: () => openDirect('live', '4521', 'm3u8'), className: "bg-green-700 text-white px-4 py-2 rounded text-sm flex-1" }, "Testar Globo/SBT"),
                                    React.createElement('button', { onClick: () => openDirect('movie', '3321', 'mp4'), className: "bg-blue-700 text-white px-4 py-2 rounded text-sm flex-1" }, "Testar Filme")
                                ),
                                React.createElement('p', { className: "text-[10px] text-gray-500 mt-2 text-center" }, "*Isso tentará abrir o app VLC ou MX Player instalado.")
                            )
                        ) : React.createElement('div', null,
                            // Lista normal se carregou
                            React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-4 gap-3" },
                                (activeTab === 'home' ? vod.slice(0, 50) : live.slice(0, 50)).map((item, i) => 
                                    React.createElement('div', { key: i, onClick: () => openDirect(activeTab === 'home' ? 'movie' : 'live', item.stream_id, item.container_extension || 'm3u8'), className: "bg-gray-800 rounded aspect-[2/3] relative overflow-hidden cursor-pointer" },
                                        React.createElement('img', { src: item.stream_icon, className: "w-full h-full object-cover", onError: e => e.target.style.display='none' }),
                                        React.createElement('div', { className: "absolute bottom-0 w-full bg-black/80 p-2" },
                                            React.createElement('p', { className: "text-[10px] font-bold truncate" }, item.name)
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    // Tab Bar
                    React.createElement('div', { className: "fixed bottom-0 w-full bg-[#111] border-t border-gray-800 flex justify-around p-3 z-50" },
                        React.createElement('button', { onClick: () => setActiveTab('home'), className: activeTab === 'home' ? "text-white" : "text-gray-600" }, React.createElement(Film, { size: 24 })),
                        React.createElement('button', { onClick: () => setActiveTab('live'), className: activeTab === 'live' ? "text-white" : "text-gray-600" }, React.createElement(Tv, { size: 24 }))
                    )
                );
            };

            return user ? React.createElement(Dashboard) : React.createElement(LoginScreen);
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>


